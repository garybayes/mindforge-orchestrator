---
# yamllint disable rule:truthy
name: Task Assistant • Meta Dashboard Build

on:
  schedule:
    - cron: "0 * * * *"
  workflow_dispatch: {}

permissions:
  contents: write

jobs:
  build-meta-dashboard:
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ github.token }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install jq
        run: sudo apt-get install -y jq

      - name: Debug file structure
        run: |
          echo "WORKING DIRECTORY:"
          pwd
          echo "FILE LIST:"
          ls -R .
          echo "CHECKING repos.json:"
          if [ -f "./meta-dashboard/repos.json" ]; then
            echo "repos.json exists."
          else
            echo "ERROR: repos.json is missing!"
          fi

      - name: Diagnostic – Show Workspace
        run: |
          echo "PWD:"
          pwd
          echo "Directory tree:"
          ls -R .
          echo "Check meta-dashboard file:"
          ls -l meta-dashboard || echo "meta-dashboard missing"
          echo "repos.json contents:"
          cat meta-dashboard/repos.json \
            || echo "repos.json missing or unreadable"

      - name: Build meta-dashboard.json
        run: |
          mkdir -p meta-dashboard

          echo '{}' > meta-dashboard/meta-dashboard.json

          jq \
            --arg ts "$(date -u +'%Y-%m-%dT%H:%M:%SZ')" \
            '. + {
              generated_at: $ts,
              meta_version: "1.1.0",
              repos: {}
            }' \
            meta-dashboard/meta-dashboard.json \
            > meta-dashboard/tmp.json

          mv meta-dashboard/tmp.json \
            meta-dashboard/meta-dashboard.json

          jq -c '.repositories[]' \
            "./meta-dashboard/repos.json" |
          while read -r r; do
            id=$(echo "$r" | jq -r '.id')
            owner=$(echo "$r" | jq -r '.owner')
            repo=$(echo "$r" | jq -r '.repo')
            workflow=$(echo "$r" | jq -r '.workflow')
            display=$(echo "$r" | jq -r '.display_name')

            WF1="repos/$owner/$repo/actions/workflows"
            WF_PATH="$WF1/$workflow/runs"

            STATUS=$(gh api "$WF_PATH" \
              --jq '.workflow_runs[0].conclusion' \
              2>/dev/null || echo "unknown")

            jq \
              --arg id "$id" \
              --arg repo "$owner/$repo" \
              --arg display "$display" \
              --arg workflow "$workflow" \
              --arg status "$STATUS" \
              '.repos[$id] = {
                repo: $repo,
                display_name: $display,
                workflow: $workflow,
                status: $status
              }' \
              meta-dashboard/meta-dashboard.json \
              > meta-dashboard/tmp.json

            mv meta-dashboard/tmp.json \
              meta-dashboard/meta-dashboard.json
          done

          echo "FINAL:"
          cat meta-dashboard/meta-dashboard.json

      - name: Commit Dashboard
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Update meta-dashboard.json"
          add_options: '--all'
